@page "/Transacciones"
@inherits PasarelaPago.Client.Pages.DashboardPagos.DashboardPagos
@using PasarelaPago.Shared.Dtos
@using MudBlazor.Extensions
@using System.Globalization

<Header>Transacciones</Header>

<MudCard>
    <MudCardContent>
        <MudGrid Class="ma-4">
            <MudItem xs="4" sm="4" md="3" lg="2" xl="1" xxl="1">
                <MudSelect Dense="true" T="string" Label="Estado" Margin="Margin.Dense" Variant="Variant.Outlined" @bind-Value="Filtro.EstadoTransaccion">
                    <MudSelectItem T="string" Value="@((string)null)">Todos</MudSelectItem>
                    <MudSelectItem T="string" Value="@("aprobado")">Aprobado</MudSelectItem>
                    <MudSelectItem T="string" Value="@("rechazado")">Rechazado</MudSelectItem>
                </MudSelect>
            </MudItem>

            <MudItem xs="4" sm="4" md="3" lg="2" xl="1" xxl="1">
                <MudDatePicker Label="Fecha inicio" @bind-Date="Filtro.FechaInicio" />
            </MudItem>

            <MudItem xs="4" sm="4" md="3" lg="2" xl="1" xxl="1">
                <MudDatePicker Label="Fecha fin" @bind-Date="Filtro.FechaFin" />
            </MudItem>
            <MudItem xs="4" sm="4" md="3" lg="2" xl="1" xxl="1">
                <MudButton Variant="Variant.Filled" Color="Color.Info" OnClick="CargarDashboard">Buscar</MudButton>
            </MudItem>
        </MudGrid>
    </MudCardContent>
</MudCard>

<MudGrid>
    <MudItem xs="12" sm="12" md="12" lg="12" xl="12" xxl="12">
        
        <MudTable T="DTOTransacciones" 
                  Items="@Transacciones" 
                  Dense="true" 
                  Hover="true" 
                  Bordered="false" 
                  Striped="false" 
                  Elevation="2"
                  @bind-SelectedItem="SelectedTransaccion" 
                  SortLabel="Ordenar por"
                  Filter="new Func<DTOTransacciones,bool>(QuickFilter)"
                  >
            
            <ToolBarContent>
                <MudButton Variant="Variant.Text" OnClick="ExportarAExcel" 
                           Style="color: #6c757d; font-weight: 500; text-transform: none;">
                    <span class="d-flex align-items-center">
                        <i class="fas fa-file-excel mr-2" style="font-size: 1.1em;"></i> 
                        Excel Export
                    </span>
                </MudButton>
                
                <MudSpacer />
                
                <MudTextField @bind-Value="SearchString" Placeholder="Buscar..." Adornment="Adornment.End" 
                              AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0" 
                              Style="max-width: 250px;" />
            </ToolBarContent>

            <HeaderContent>
                <MudTh><MudTableSortLabel T="DTOTransacciones" SortBy="new Func<DTOTransacciones, object>(x=>x.cedula!)">Cédula</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel T="DTOTransacciones" SortBy="new Func<DTOTransacciones, object>(x=>x.nombreCliente!)">Nombre</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel T="DTOTransacciones" SortBy="new Func<DTOTransacciones, object>(x=>x.pais!)">País</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel T="DTOTransacciones" SortBy="new Func<DTOTransacciones, object>(x=>x.moneda!)">Moneda</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel T="DTOTransacciones" SortBy="new Func<DTOTransacciones, object>(x=>x.monto)">Monto</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel T="DTOTransacciones" SortBy="new Func<DTOTransacciones, object>(x=>x.numeroOrden!)"># Orden</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel T="DTOTransacciones" SortBy="new Func<DTOTransacciones, object>(x=>x.fechaTransaccion!)">Fecha</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel T="DTOTransacciones" SortBy="new Func<DTOTransacciones, object>(x=>x.estadoTransaccion!)">Estado</MudTableSortLabel></MudTh>
            </HeaderContent>

            <RowTemplate>
                <MudTd DataLabel="Cédula">@context.cedula</MudTd>
                <MudTd DataLabel="Nombre">@context.nombreCliente</MudTd>
                <MudTd DataLabel="País">@ToCountryName(context.pais)</MudTd>
                <MudTd DataLabel="Moneda">@ToCurrencyName(context.moneda)</MudTd>
                <MudTd DataLabel="Monto" Class="text-right">
                    @CurrencySymbol(context.moneda) @FormatMoney(context.monto, context.moneda)
                </MudTd>
                <MudTd DataLabel="# Orden">@context.numeroOrden</MudTd>
                <MudTd DataLabel="Fecha">
                    @if (context.fechaTransaccion.HasValue)
                    {
                        @context.fechaTransaccion.Value.ToString("dd/MM/yyyy")
                    }
                </MudTd>
                <MudTd DataLabel="Estado">
                    @{
                        // 🚨 Nota: La variable 's' ahora usa la propiedad estadoTransaccion normalizada por la API
                        var s = (context.estadoTransaccion ?? "").Trim().ToLowerInvariant();
                        bool aprobado = s == "aprobado";
                        bool rechazado = s == "rechazado";
                    }
                    @if (aprobado)
                    {
                        <MudText Color="Color.Success" Style="font-size:12px;font-weight:bold;">Aprobado</MudText>
                    }
                    else if (rechazado)
                    {
                        <MudText Color="Color.Error" Style="font-size:12px;font-weight:bold;">Rechazado</MudText>
                    }
                    else
                    {
                        <MudText Color="Color.Info" Style="font-size:12px;font-weight:bold;">
                            @context.estadoTransaccion
                        </MudText>
                    }
                </MudTd>
            </RowTemplate>

            <NoRecordsContent>
                <MudText>No se encontraron transacciones que coincidan.</MudText>
            </NoRecordsContent>

            <PagerContent>
                <MudTablePager PageSizeOptions="new int[]{10, 25, 50, 100}" />
            </PagerContent>
            
        </MudTable>
    </MudItem>
</MudGrid>